// This is your Prisma schema file for ProcessX
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password_hash String?
  first_name    String
  last_name     String
  phone         String?
  email_verified Boolean  @default(false)
  is_active     Boolean   @default(true)
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  last_login_at DateTime?

  // Relations
  company_members CompanyMember[]
  expenses        Expense[]
  created_companies Company[] @relation("CreatedBy")
  accounts        Account[]
  sessions        Session[]

  @@index([email])
  @@map("users")
}

// ============================================
// COMPANY MANAGEMENT
// ============================================

model Company {
  id                    String    @id @default(cuid())
  name                  String
  registration_number   String?
  tax_number            String?
  vat_number            String?
  business_type         String?   // "small_business_corporation" | "standard_company" | "sole_proprietor"
  address_line1         String?
  address_line2         String?
  city                  String?
  province              String?
  postal_code           String?
  country               String    @default("South Africa")
  phone                 String?
  email                 String?
  website               String?
  fiscal_year_end       String?   // MM-DD format
  currency              String    @default("ZAR")
  logo_url              String?
  is_active             Boolean   @default(true)
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt
  created_by_id         String

  // Relations
  created_by      User            @relation("CreatedBy", fields: [created_by_id], references: [id])
  members         CompanyMember[]
  expenses        Expense[]
  income          Income[]
  expense_categories ExpenseCategory[]
  income_categories  IncomeCategory[]

  @@index([created_by_id])
  @@map("companies")
}

model CompanyMember {
  id          String   @id @default(cuid())
  company_id  String
  user_id     String
  role        String   // "owner" | "admin" | "accountant" | "viewer"
  permissions Json?    // Additional granular permissions
  is_active   Boolean  @default(true)
  joined_at   DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relations
  company Company @relation(fields: [company_id], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([company_id, user_id])
  @@index([company_id])
  @@index([user_id])
  @@map("company_members")
}

// ============================================
// EXPENSE MANAGEMENT
// ============================================

model ExpenseCategory {
  id         String   @id @default(cuid())
  company_id String?  // NULL for system categories
  name       String
  color      String?  // Hex color for UI
  icon       String?  // Icon name
  is_system  Boolean  @default(false)
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  company  Company?  @relation(fields: [company_id], references: [id], onDelete: Cascade)
  expenses Expense[]

  @@index([company_id])
  @@map("expense_categories")
}

model Expense {
  id              String    @id @default(cuid())
  company_id      String
  category_id     String
  user_id         String    // Who created the expense
  amount          Decimal   @db.Decimal(12, 2)
  currency        String    @default("ZAR")
  expense_date    DateTime
  vendor_name     String?
  description     String?
  payment_method  String?   // "cash" | "bank_transfer" | "credit_card" | "debit_card"
  receipt_url     String?
  is_tax_deductible Boolean @default(true)
  is_recurring    Boolean   @default(false)
  recurrence_pattern String? // "monthly" | "quarterly" | "annually"
  status          String    @default("pending") // "pending" | "approved" | "rejected"
  approved_by_id  String?
  approved_at     DateTime?
  notes           String?   @db.Text
  is_deleted      Boolean   @default(false)
  deleted_at      DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  // Relations
  company  Company         @relation(fields: [company_id], references: [id], onDelete: Cascade)
  category ExpenseCategory @relation(fields: [category_id], references: [id])
  user     User            @relation(fields: [user_id], references: [id])

  @@index([company_id])
  @@index([category_id])
  @@index([user_id])
  @@index([expense_date])
  @@index([is_deleted])
  @@map("expenses")
}

// ============================================
// INCOME MANAGEMENT (Future Phase)
// ============================================

model IncomeCategory {
  id         String   @id @default(cuid())
  company_id String?  // NULL for system categories
  name       String
  color      String?
  icon       String?
  is_system  Boolean  @default(false)
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  company Company? @relation(fields: [company_id], references: [id], onDelete: Cascade)
  income  Income[]

  @@index([company_id])
  @@map("income_categories")
}

model Income {
  id              String   @id @default(cuid())
  company_id      String
  category_id     String
  amount          Decimal  @db.Decimal(12, 2)
  currency        String   @default("ZAR")
  income_date     DateTime
  source_name     String?  // Client/customer name
  description     String?
  payment_method  String?
  invoice_number  String?
  notes           String?  @db.Text
  is_deleted      Boolean  @default(false)
  deleted_at      DateTime?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relations
  company  Company        @relation(fields: [company_id], references: [id], onDelete: Cascade)
  category IncomeCategory @relation(fields: [category_id], references: [id])

  @@index([company_id])
  @@index([category_id])
  @@index([income_date])
  @@index([is_deleted])
  @@map("income")
}

// ============================================
// NEXTAUTH MODELS
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}
